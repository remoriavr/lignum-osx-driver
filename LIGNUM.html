<html>
  <head>
    <meta charset="utf-8">
    <title>LIGNUM Controller Universal Driver</title>
	<script>
		var gui = require('nw.gui');
		var tray = new gui.Tray({ title: 'LIGNUM',tooltip:'LIGNUM Status'});
		var menu = new gui.Menu();
		var status_item = new gui.MenuItem({ label: 'Status: Disconnected' });
    menu.append(status_item);
		menu.append(new gui.MenuItem({ type: 'separator' }));
    var pps_item = new gui.MenuItem({ label: 'PPS: -' });
    menu.append(pps_item);
		var x_item = new gui.MenuItem({ label: 'X: -' });
		var y_item = new gui.MenuItem({ label: 'Y: -' });
		var z_item = new gui.MenuItem({ label: 'Z: -' });
    var gesture_item = new gui.MenuItem({ label: 'Gesture: -' });
		menu.append(x_item);
		menu.append(y_item);
		menu.append(z_item);
    menu.append(gesture_item);
		var buttons_item = new gui.MenuItem({ label: 'Button Pressed: -' });
		var joystick_item = new gui.MenuItem({ label: 'Joystick Direction: -' });
		var battery_item = new gui.MenuItem({ label: 'Battery Status: -' });
		menu.append(buttons_item);
		menu.append(joystick_item);
		menu.append(battery_item);
		menu.append(new gui.MenuItem({ type: 'separator' }));
		var quit_item = new gui.MenuItem({ label: 'Exit', click: function () { gui.App.quit(); }});
		menu.append(quit_item);
		tray.menu = menu;
		var win = gui.Window.get();
		win.hide();
		win.on('close', function ()
		{
			gui.App.closeAllWindows();
			win.close(true);
		});

    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function()
    {
      if (xhttp.readyState == 4 && xhttp.status == 200)
      {
        status_item.label = 'status: polling';
        pps++;
        if (xhttp.responseText.indexOf(':') > 0)
        {
          gesture_item.label = 'gesture: ' + xhttp.responseText.split(':')[1].replace('|','');
        }
        else
        {
          var LIGNUM_PACKET = xhttp.responseText.replace('|','').split(',');
          if(LIGNUM_PACKET.length == 6)
          {
            x_item.label = 'x: ' + LIGNUM_PACKET[0];
            y_item.label = 'y: ' + LIGNUM_PACKET[1];
            z_item.label = 'z: ' + LIGNUM_PACKET[2];
            joystick_item.label = 'joystick: ' + LIGNUM_PACKET[3];
            buttons_item.label = 'buttons: ' + LIGNUM_PACKET[4];
            battery_item.label = 'battery: ' + LIGNUM_PACKET[5];
          }
        }
      }
    };

    setInterval(function()
    {
      xhttp.open("GET", "http://127.0.0.1:5191", true);
      xhttp.send();
    },15);

    // packets per second counter
    var pps = 0;
    setInterval(function()
    {
      pps_item.label = 'pps: ' + pps;
      pps = 0;
    },1000);
    window.onload = function()
    {
      status_item.label = 'status: initializing';
    };
	</script>
  </head>
</html>
